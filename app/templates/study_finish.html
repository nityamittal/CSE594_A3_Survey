<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Study – Finished</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: Roboto, system-ui, -apple-system, Segoe UI, Arial; background:#f8fafc; color:#111827; margin:0; }
    .wrap { max-width: 720px; margin: 12vh auto; background:#fff; border:1px solid #e5e7eb; border-radius:16px; padding:32px; }
    h1 { margin:0 0 8px 0; font-size: 28px; }
    p { color:#4b5563; }
    .btns { display:flex; gap:12px; margin-top:20px; }
    button { padding:12px 16px; border-radius:10px; border:1px solid #e5e7eb; cursor:pointer; font-weight:600; }
    .primary { background:#7c3aed; color:white; border-color:#6d28d9; }
    .ghost { background:white; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Thanks! You completed this block.</h1>
    <p>You can submit now, or do <strong>another {{ config['STUDY_TRIALS_PER_PARTICIPANT'] or 10 }}</strong> trials to help our study.</p>
    <div class="btns">
      <button id="more" class="primary">Do another {{ config['STUDY_TRIALS_PER_PARTICIPANT'] or 10 }}</button>
      <button id="exit" class="ghost">Finish &amp; Submit</button>
    </div>
    <p id="msg" style="margin-top:16px;"></p>
  </div>
  <script>
    const msg = document.getElementById('msg');
    const pid = sessionStorage.getItem('participant_id');
    if (!pid) { location.href = '/study'; }

    document.getElementById('more').onclick = async () => {
      msg.textContent = 'Assigning the next block…';
      const res = await fetch('/study/extend', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ participant_id: Number(pid) })
      });
      if (res.ok) {
        const d = await res.json();
        if (d.added > 0) {
          location.href = '/study/run';
        } else {
          msg.textContent = 'No more trials available.';
        }
      } else {
        const d = await res.json().catch(()=>({error:'unknown'}));
        msg.textContent = 'Could not assign more trials: ' + (d.error || res.statusText);
      }
    };

    document.getElementById('exit').onclick = () => {
      // You could show a completion code here instead.
      alert('Copy your completion code from the instructions page, then return to MTurk.');
      // Or redirect to a dedicated completion page if implemented:
      // location.href = '/study/complete?code=...';
    };
  </script>
</body>
</html>
